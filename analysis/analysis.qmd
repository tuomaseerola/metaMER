# Analysis

This assumes that the data has been parsed from the BibTeX files into table and exported as CSV file.

## Read annotated data

- Update 2024-06-19
- [ ] CA TODO: find better way to read in functions

```{r}
require(here)
source(here::here('R/build-df.R'))
source(here::here('R/format-study-results.R'))
source(here::here('R/parse-model-output.R'))
```

- [ ] CA ToDo: Check the warning reported here

```{r}
# get metaMER df:
meta_df <- get_metaMER_df(path_2_studies = here::here('studies'))

# get included studies
included_studies <- meta_df[which(
  !stringr::str_detect(meta_df$final_notes, '!EXCL!')),] |> 
  dplyr::tibble()

```
### Recoded


```{r}
# get studies re-coded (currently identifiable by presence of bind_field.)
recoded_studies <- included_studies[which(stringr::str_detect(
  included_studies$model_rate_emotion_values,
                                     'bind_field')),] 

```

Maybe limit the verbosity of `get_study_results` below

```{r}
metaMER_results <-
do.call(
  rbind,
    lapply(1:nrow(recoded_studies),
       function(x) get_study_results(recoded_studies[x,])
       )
) 

metaMER_results |> dplyr::tibble()

```


## Summarise annotated data

```{r}
#| eval: true
#| output: asis

print(knitr::kable(table(metaMER_results$citekey,metaMER_results$dimension)))
print(knitr::kable(table(metaMER_results$citekey,metaMER_results$model_id)))
print(knitr::kable(table(metaMER_results$citekey,metaMER_results$feature_id)))
print(knitr::kable(table(metaMER_results$citekey,metaMER_results$data_id)))

```


## Analysis notes

- [ ] Issue 1: We need unique identifiers for each input component (combine: `study` + `model` + `feature` + `data` + `experiment` that would have be unique id)
- [ ] Issue 2: We `stimulus_N`
- [ ] Issue 3: measure vs statistic?
- [ ] Issue 4: We need to classify the modelling techniques into fewer number of techniques
- [ ] Issue 5: We could polish citekey into ref (xu2021us to Xu 2021 et al., ) for nicer plotting output (can be done with `str_replace`)

### Regression studies

#### Valence

```{r}
#| warning: false
#| eval: true
library(dmetar)
library(tidyverse)
library(meta)

# select regression studies with r2
tmp <- dplyr::filter(metaMER_results,dimension=="valence" & measure=="r2")
#sqrt(tmp$values) # convert from R^2 to r
tmp$stimulus_n <- 100 # ad-hoc for now

m.cor <- metacor(cor = sqrt(values), 
                 n = stimulus_n,
                 studlab = citekey,
                 data = tmp,
                 fixed = FALSE,
                 random = TRUE,
                 sm = "ZCOR",
                 method.tau = "REML",# could be PM (Paule-Mandel) as well
                 method.random.ci = "HK", 
                 title = "MER: Regression: Valence: All")

print(m.cor)
```

## Explore qualities

```{r}
meta <- metagen(values, sqrt(values), 
                data = tmp, 
                studlab = tmp$citekey, 
                comb.fixed = FALSE, 
                method.tau = "PM")
find.outliers(meta)
infan <- InfluenceAnalysis(meta)
print(eggers.test(meta))

```

## Sub-group analysis (based on model type)

```{r}

meta <- metagen(values, sqrt(values), # Fix the TE.se 
                data = tmp, 
                studlab = tmp$citekey, 
                comb.fixed = FALSE, 
                method.tau = "PM")

subgroup.analysis.mixed.effects(x = meta, 
                                subgroups = tmp$model_id)
```

## Visualise

```{r}
plot(m.cor)
plot(eggers.test(meta))

```